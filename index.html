<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>html-to-md live demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/3.0.1/github-markdown.min.css" />
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/styles/default.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/8.4.2/markdown-it.min.js"></script>
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js"></script>
    <style>
        html{
            font-size:16px;
            line-height: 1.5;
        }
        img{
            width:30%;
        }
        #wrap{
            display:flex;
            justify-content: space-between;
        }
        .io{
            font-size:0.8rem;
            width:33%;
            resize: horizontal;
            min-width: 20%;
            height: 80vh;
        }
        #outputHTML, #outputMD{
            border:1px solid #a9a9a9;;
            overflow:auto;
        }
        #outputMD{
            resize: none;
            flex: 1
        }
        textarea{
            line-height:1.5
        }
        .infoWrap{
            display:flex;
            justify-content: space-evenly;
        }
        .info{
            font-size:1rem;
            font-weight: bold;
        }
        #syncScrBtnRender{
            border: 1px;
            background: lightgreen;
            padding: 0.2rem;
            border-radius: 4px;
            margin: 0.5rem;
            display: inline-block;
            cursor:pointer;
        }
    </style>
</head>
<body>
<div class="infoWrap">
    <span class="info">markdown</span>
    <span class="info">
        <span style="font-size:0.8rem">ËΩ¨Êç¢Â∑•ÂÖ∑ÈÄâÊã©üëâ</span>
        <select id="chooseM2H">
            <option value="markdown-it">markdown-it</option>
            <option value="marked">marked</option>
        </select>
    </span>
    <span class="info">html</span>
    <span class="info">
        <span>üëâ</span>
        <select disabled>
            <option value="html-to-md">html-to-md</option>
        </select>
    </span>
    <span class="info">markdown</span>
</div>
<div id="wrap" class="markdown-body ">
    <textarea id="inputMD" class="io"></textarea>
    <div id="outputHTML" class="io" ></div>
    <textarea id="outputMD" readonly class="io"></textarea>
</div>
<div>
    <label for="syncScrBtn" id="syncScrBtnRender">sync scroll</label><input type="checkbox" id="syncScrBtn" checked style="font-size:1rem" />
</div>


<script>
  const PLACEHOLDER='---\n' +
    '\n' +
    '# h1 Heading\n' +
    '## h2 Heading\n' +
    '### h3 Heading\n' +
    '#### h4 Heading\n' +
    '##### h5 Heading\n' +
    '###### h6 Heading\n' +
    '\n' +
    '***\n' +
    '\n' +
    '\n' +
    '## Emphasis\n' +
    '\n' +
    '***Bold and italic***\n' +
    '\n' +
    '**This is bold text**\n' +
    '\n' +
    '__This is bold text__\n' +
    '\n' +
    '*This is italic text*\n' +
    '\n' +
    '_This is italic text_\n' +
    '\n' +
    '~~Strikethrough~~\n' +
    '\n' +
    '\n' +
    '## Blockquotes\n' +
    '\n' +
    '\n' +
    '> Blockquotes can also be nested...\n' +
    '>> ...by using additional greater-than signs right next to each other...\n' +
    '> > > ...or with spaces between arrows.\n' +
    '\n' +
    '\n' +
    '### Blockquote list\n' +
    '\n' +
    '> * list1\n' +
    '> * list2\n' +
    '> * list3\n' +
    '\n' +
    '\n' +
    '## Lists\n' +
    '\n' +
    'Unordered\n' +
    '\n' +
    '+ Create a list by starting a line with `+`, `-`, or `*`\n' +
    '+ Sub-lists are made by indenting 2 spaces:\n' +
    '  - Marker character change forces new list start:\n' +
    '    * Ac tristique libero volutpat at\n' +
    '    + Facilisis in pretium nisl aliquet\n' +
    '    - Nulla volutpat aliquam velit\n' +
    '+ Very easy!\n' +
    '\n' +
    'Ordered-1\n' +
    '\n' +
    '1. Lorem ipsum dolor sit amet\n' +
    '2. Consectetur adipiscing elit\n' +
    '3. Integer molestie lorem at massa\n' +
    '1. You can use sequential numbers...\n' +
    '1. ...or keep all the numbers as `1.`\n' +
    '\n' +
    'Ordered-2\n' +
    '\n' +
    '1. Lorem ipsum dolor sit amet\n' +
    '\n' +
    '2. Consectetur adipiscing elit\n' +
    '3. Integer molestie lorem at massa\n' +
    '1. You can use sequential numbers...\n' +
    '1. ...or keep all the numbers as `1.`\n' +
    '\n' +
    'Start numbering with offset:\n' +
    '\n' +
    '57. foo\n' +
    '1. bar\n' +
    '\n' +
    '\n' +
    '## Code\n' +
    '\n' +
    'Block code "fences"\n' +
    '\n' +
    '```\n' +
    'Sample text here...\n' +
    '```\n' +
    '\n' +
    'Syntax highlighting\n' +
    '\n' +
    '``` js\n' +
    'var foo = function (bar) {\n' +
    '  return bar++;\n' +
    '};\n' +
    '\n' +
    'console.log(foo(5));\n' +
    '```\n' +
    '\n' +
    '\n' +
    '## Tables\n' +
    '\n' +
    '| Option | Description |\n' +
    '| ------ | ----------- |\n' +
    '| data   | path to data files to supply the data that will be passed into templates. |\n' +
    '| engine | engine to be used for processing templates. Handlebars is the default. |\n' +
    '| ext    | extension to be used for dest files. |\n' +
    '\n' +
    'Right aligned columns\n' +
    '\n' +
    '| Option | Description |\n' +
    '| ------:| -----------:|\n' +
    '| data   | path to data files to supply the data that will be passed into templates. |\n' +
    '| engine | engine to be used for processing templates. Handlebars is the default. |\n' +
    '| ext    | extension to be used for dest files. |\n' +
    '\n' +
    '\n' +
    '## Links\n' +
    '\n' +
    '[link text](http://dev.nodeca.com)\n' +
    '\n' +
    '[link with title](http://nodeca.github.io/pica/demo/ "title text!")\n' +
    '\n' +
    'Autoconverted link https://github.com/nodeca/pica (enable linkify to see)\n' +
    '\n' +
    '\n' +
    '## Images\n' +
    '\n' +
    '![Minion](https://octodex.github.com/images/minion.png)\n' +
    '![Stormtroopocat](https://octodex.github.com/images/stormtroopocat.jpg "The Stormtroopocat")\n' +
    '\n' +
    'Like links, Images also have a footnote style syntax\n' +
    '\n' +
    '![Alt text][id]\n' +
    '\n' +
    'With a reference later in the document defining the URL location:\n' +
    '\n' +
    '[id]: https://octodex.github.com/images/dojocat.jpg  "The Dojocat"\n' +
    '\n' +
    '#### Complicate list\n' +
    '\n' +
    '\n' +
    '* **STRONG**\n' +
    '* [ATag]()\n' +
    '    1. order-1\n' +
    '    2. order-2\n' +
    '        * one\n' +
    '        * two\n' +
    '            >1. bq-nest-1\n' +
    '            >>1. bq-nest-2\n' +
    '            >>>1. bq-nest-3\n' +
    '    3. order-3\n' +
    '        1. code\n' +
    '            ```javascript\n' +
    '            function a(){\n' +
    '                let b=5\n' +
    '                let obj={\n' +
    '                        x:100\n' +
    '                    }\n' +
    '                return obj.x+b\n' +
    '            }\n' +
    '            ```\n' +
    '        2. [html-to-md-demo](https://stonehank.github.io/html-to-md/)\n' +
    '            * ![avatar](https://avatars1.githubusercontent.com/u/26397640?s=40&v=4)\n' +
    '    4. order-4\n' +
    '\n' +
    '## Todo list(Can be parsed by marked. )\n' +
    '\n' +
    '- [ ] not finish-1\n' +
    '- [ ] not finish-2\n' +
    '- [ ] not finish-3\n' +
    '- [ ] not finish-4\n' +
    '\n' +
    '## Done list(Can be parsed by marked. )\n' +
    '\n' +
    '- [x] finish-1\n' +
    '- [x] finish-2\n' +
    '- [x] finish-3\n' +
    '- [x] finish-4\n'
</script>
<script>
  window.onload=()=>{

    let hljs=window.hljs
    let io=document.getElementsByClassName("io")
    let mdItObj=window.markdownit({
        html:true,
        highlight: function (str, lang) {
          let langClass='"hljs language-'+lang+'"'
          if (lang && hljs.getLanguage(lang)) {
            try {
              return '<pre class='+langClass+'><code>' +
                hljs.highlight(lang, str, true).value +
                '</code></pre>';
            } catch (__) {}
          }
          return '<pre class="hljs"><code>' + mdItObj.utils.escapeHtml(str) + '</code></pre>';
        }
      }),
      mdIt=mdItObj.render.bind(mdItObj),
      marked=window.marked,
      html2md=window.html2md,
      inputMd=document.getElementById("inputMD"),
      outputMD=document.getElementById("outputMD"),
      outputHTML=document.getElementById("outputHTML"),
      chooseM2H=document.getElementById("chooseM2H"),
      syncScrBtn=document.getElementById("syncScrBtn")
    let md2Html=mdIt
    let delay=false,timer=null

    marked.setOptions({
      highlight: function(str, lang) {
        if (lang && hljs.getLanguage(lang)) {
          try {
            return hljs.highlight(lang, str, true).value
          } catch (__) {}
        }

        return mdItObj.utils.escapeHtml(str)
      }
    });


    function syncScroll(ev){
      let ele=ev.target
      if(!delay){
        clearTimeout(timer)
        delay=true
        if(ele.className==='io'){
          let scrRatio=ele.scrollTop/ ele.scrollHeight
          for(let j=0;j<io.length;j++){
            if(io[j]===ele)continue
            io[j].scrollTo({
              top:io[j].scrollHeight*scrRatio
            })
          }
        }
        timer=setTimeout(()=>{
          delay=false
        },30)
      }
    }

    chooseM2H.addEventListener("change",(ev)=>{
      md2Html=ev.target.value==="marked" ? marked : mdIt
      show()
    })

    syncScrBtn.addEventListener('change',toggleEvent)

    function bindScr(io){
      for(let i=0;i<io.length;i++){
        let ele=io[i]
        ele.addEventListener("scroll",syncScroll)
      }
    }
    function unbindScr(io){
      for(let i=0;i<io.length;i++){
        let ele=io[i]
        ele.removeEventListener("scroll",syncScroll)
      }
    }
    function toggleEvent(ev){
      if(ev.target.checked){
        bindScr(io)
      }else{
        unbindScr(io)
      }

    }

    inputMd.addEventListener("input",()=>{
      show()
    })

    inputMd.value=PLACEHOLDER
    show()
    bindScr(io)
    function show(){
      render(inputMd,md2Html,html2md,outputHTML,outputMD)
    }

  }
</script>
<script>


  function render(inputMd,md2Html,html2md,outputHTML,outputMD){
    let val=inputMd.value
    let htmlOutput=md2Html(val)
    let mdOutput=html2md(htmlOutput)
    outputHTML.innerHTML=htmlOutput
    outputMD.innerHTML=mdOutput
  }
</script>
<script>
  let unescapeMap = {};
  let escapeMap = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
    '`': '&#x60;',
  };

  for (let key in escapeMap) {
    unescapeMap[escapeMap[key]] = key;
  }

  let reUnescapedHtml = /[&<>"'`]/g
  let reHasUnescapedHtml = RegExp(reUnescapedHtml.source)
  let reEscapedHtml = /&(?:amp|lt|gt|quot|#39|#x60);/g
  let reHasEscapedHtml = RegExp(reEscapedHtml.source)

  function escape(s) {
    return (s && reHasUnescapedHtml.test(s)) ?
      s.replace(reUnescapedHtml, (chr) => escapeMap[chr]) :
      s
  }

  function unescape(s) {
    return (s && reHasEscapedHtml.test(s)) ?
      s.replace(reEscapedHtml, (entity) => unescapeMap[entity]) :
      s
  }

  window.unescape=unescape
</script>
</body>
</html>